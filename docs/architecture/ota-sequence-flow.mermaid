sequenceDiagram
    participant Admin as Admin/Dashboard
    participant HB as hawkBit Server
    participant MQTT as MQTT Broker
    participant MinIO as Package Storage
    participant Sign as Signing Service
    participant Device as Vehicle Device
    participant Boot as Bootloader
    participant Monitor as Monitoring
    
    Note over Admin,Monitor: Phase 1: Package Preparation
    Admin->>HB: Create Update Campaign<br/>(Target: Fleet A, Version 2.0)
    Admin->>MinIO: Upload Update Package
    MinIO->>Sign: Request Package Signature
    Sign->>Sign: Sign with Private Key
    Sign-->>MinIO: Return Signed Package
    HB->>HB: Create Deployment<br/>(Staged Rollout: 10%)
    
    Note over Admin,Monitor: Phase 2: Update Discovery
    Device->>MQTT: Subscribe to update topic<br/>(device/VIN123/updates)
    HB->>MQTT: Publish Update Available<br/>(10% of fleet)
    MQTT->>Device: Update Notification<br/>(Version 2.0 available)
    Device->>HB: Poll for Update Details
    HB-->>Device: Return Update Metadata<br/>(Size, Hash, URL)
    
    Note over Admin,Monitor: Phase 3: Pre-Download Checks
    Device->>Device: Check Storage Space<br/>(Partition B: 2GB free)
    Device->>Device: Check Battery/Power<br/>(>50% or charging)
    Device->>Device: Check Network<br/>(WiFi/4G available)
    Device->>Monitor: Report Pre-check Status
    
    Note over Admin,Monitor: Phase 4: Download & Verification
    Device->>MinIO: Download Package<br/>(with resume support)
    MinIO-->>Device: Stream Package Data<br/>(Delta: 200MB)
    Device->>Device: Verify Package Hash<br/>(SHA-256)
    Device->>Sign: Verify Signature<br/>(with Public Key)
    Sign-->>Device: Signature Valid
    Device->>Monitor: Report Download Complete
    
    Note over Admin,Monitor: Phase 5: Installation
    Device->>Device: Mount Partition B<br/>(standby partition)
    Device->>Device: Extract & Install<br/>(SWUpdate process)
    Device->>Device: Set Boot Flag<br/>(next boot: Partition B)
    Device->>Monitor: Report Installation Ready
    Device->>MQTT: Publish Status<br/>(ready_for_reboot)
    
    Note over Admin,Monitor: Phase 6: Reboot & Activation
    Device->>Device: Schedule Reboot<br/>(user consent or auto)
    Device->>Boot: Reboot
    Boot->>Boot: Read Boot Flag
    Boot->>Boot: Boot from Partition B<br/>(new version)
    Boot->>Device: Start System
    
    Note over Admin,Monitor: Phase 7: Health Check
    Device->>Device: Run Health Checks<br/>(Services, connectivity)
    Device->>Device: Version Verification<br/>(confirm v2.0 running)
    
    alt Successful Update
        Device->>Boot: Commit Boot Flag<br/>(permanent)
        Device->>MQTT: Report Success<br/>(update_successful)
        MQTT->>HB: Update Device Status
        HB->>Monitor: Success Metrics
        Device->>Monitor: Telemetry: v2.0 stable
        Note over Device: Rollback protection:<br/>Partition A marked inactive
    else Health Check Failed
        Device->>Boot: Revert Boot Flag
        Device->>Device: Trigger Watchdog Reset
        Boot->>Boot: Boot from Partition A<br/>(previous version)
        Device->>MQTT: Report Rollback<br/>(update_failed, reverted)
        MQTT->>HB: Update Failed Status
        HB->>Admin: Alert: Device VIN123 Rollback
        Device->>Monitor: Telemetry: Rolled back to v1.5
        Note over Device: Automatic rollback:<br/>System recovers to known-good
    end
    
    Note over Admin,Monitor: Phase 8: Fleet Progression
    HB->>HB: Check Success Rate<br/>(95% success in 10%)
    HB->>HB: Expand Rollout<br/>(Now 50% of fleet)
    HB->>MQTT: Notify Next Batch
    
    Note over Admin,Monitor: Monitoring & Analytics
    Monitor->>Admin: Dashboard Update<br/>(Success: 95%, Failed: 5%)
    Admin->>HB: Analyze Failed Devices
    HB-->>Admin: Failure Logs & Reasons
